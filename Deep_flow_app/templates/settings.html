<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - DeepFlow</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }
        .back-button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        h1 {
            margin-top: 0;
        }
        h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
            color: #2c3e50;
        }
        .section {
            margin-bottom: 30px;
        }
        .emphasize {
            background-color: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #6c757d;
            font-size: 0.9em;
        }
        /* Enhanced accessibility controls */
        .accessibility-controls {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .font-selector {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .font-selector:hover {
            box-shadow: 0 0 8px rgba(0,123,255,0.5);
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .dyslexic-font {
            font-family: 'OpenDyslexic', Arial, sans-serif !important;
        }
        @font-face {
            font-family: 'OpenDyslexic';
            src: url('{{ url_for("static", filename="fonts/OpenDyslexic-Regular.otf") }}') format('opentype');
        }
        
        /* New styles for settings forms */
        .settings-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn-submit {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-submit:hover {
            background-color: #0056b3;
        }
        .flash-message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .flash-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body id="body-element">
    <div class="header">
        <h1>DeepFlow Settings</h1>
        <p>Manage your account and preferences</p>
    </div>
    <div class="container">
        <div class="accessibility-controls">
            <h3 style="width: 100%; margin-top: 0; margin-bottom: 10px; color: #2c3e50;"><i class="fas fa-universal-access"></i> Accessibility Options</h3>
            <div class="font-selector">
                <label for="font-select"><i class="fas fa-font"></i> Font:</label>
                <select id="font-select" onchange="changeFont(this.value)">
                    <option value="default">Default Font</option>
                    <option value="dyslexic">OpenDyslexic (Dyslexia-friendly)</option>
                </select>
            </div>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Settings Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('account')">Account Settings</div>
            <div class="tab" onclick="switchTab('preferences')">Preferences</div>
            <div class="tab" onclick="switchTab('privacy')">Privacy Policy</div>
            <div class="tab" onclick="switchTab('data')">Data Management</div>
        </div>
        
        <!-- Account Settings Tab -->
        <div id="account-tab" class="tab-content active">
            <h2>Account Settings</h2>
            
            <div class="section">
                <h3>Update Username</h3>
                <form action="{{ url_for('settings') }}" method="post" class="settings-form">
                    <input type="hidden" name="action" value="update_username">
                    <div class="form-group">
                        <label for="new_username">New Username:</label>
                        <input type="text" id="new_username" name="new_username" required>
                    </div>
                    <div class="form-group">
                        <label for="username_current_password">Current Password (to verify):</label>
                        <input type="password" id="username_current_password" name="current_password" required>
                    </div>
                    <button type="submit" class="btn-submit">Update Username</button>
                </form>
            </div>
            
            <div class="section">
                <h3>Change Password</h3>
                <form action="{{ url_for('settings') }}" method="post" class="settings-form">
                    <input type="hidden" name="action" value="update_password">
                    <div class="form-group">
                        <label for="password_current_password">Current Password:</label>
                        <input type="password" id="password_current_password" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label for="new_password">New Password:</label>
                        <input type="password" id="new_password" name="new_password" required>
                        <small>Must be at least 10 characters with uppercase, number, and symbol</small>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Confirm New Password:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn-submit">Change Password</button>
                </form>
            </div>
        </div>
        
        <!-- Preferences Tab -->
        <div id="preferences-tab" class="tab-content">
            <h2>Preferences</h2>
            
            <div class="section">
                <h3>Regional Settings</h3>
                <form method="post" style="max-width: 400px;">
                    <input type="hidden" name="action" value="update_country">
                    <div class="form-group">
                        <label for="country">Country/Region:</label>
                        <select id="country" name="country" required onchange="updateCountrySelection(this.value)">
                            <option value="US" {% if current_country == 'US' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ United States</option>
                            <option value="UK" {% if current_country == 'UK' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ United Kingdom</option>
                            <option value="AU" {% if current_country == 'AU' %}selected{% endif %}>ðŸ‡¦ðŸ‡º Australia</option>
                            <option value="CA" {% if current_country == 'CA' %}selected{% endif %}>ðŸ‡¨ðŸ‡¦ Canada</option>
                            <option value="DE" {% if current_country == 'DE' %}selected{% endif %}>ðŸ‡©ðŸ‡ª Germany</option>
                            <option value="FR" {% if current_country == 'FR' %}selected{% endif %}>ðŸ‡«ðŸ‡· France</option>
                            <option value="ES" {% if current_country == 'ES' %}selected{% endif %}>ðŸ‡ªðŸ‡¸ Spain</option>
                            <option value="IT" {% if current_country == 'IT' %}selected{% endif %}>ðŸ‡®ðŸ‡¹ Italy</option>
                            <option value="JP" {% if current_country == 'JP' %}selected{% endif %}>ðŸ‡¯ðŸ‡µ Japan</option>
                            <option value="CN" {% if current_country == 'CN' %}selected{% endif %}>ðŸ‡¨ðŸ‡³ China</option>
                            <option value="IN" {% if current_country == 'IN' %}selected{% endif %}>ðŸ‡®ðŸ‡³ India</option>
                            <option value="BR" {% if current_country == 'BR' %}selected{% endif %}>ðŸ‡§ðŸ‡· Brazil</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="state-province-group" style="display: none;">
                        <label for="state_province">State/Province/Region:</label>
                        <select id="state_province" name="state_province">
                            <option value="">Select...</option>
                        </select>
                        <small id="timezone-info" class="text-muted"></small>
                    </div>
                    
                    <small class="text-muted">This affects date/time formats and timezone display in graphs and reports.</small>
                    <br><br>
                    <button type="submit" class="btn-submit">Update Location</button>
                </form>
            </div>
        </div>
        
        <!-- Privacy Policy Tab -->
        <div id="privacy-tab" class="tab-content">
            <h2>Privacy Policy</h2>
            
            <div class="section">
                <h3>Introduction</h3>
                <p>Welcome to DeepFlow's Privacy Policy. This policy describes how we collect, use, and protect your personal information as you use our application designed to support neurodivergent users, especially those with ADHD, in managing focus sessions and tracking energy levels.</p>
                <p>We understand that your privacy and the security of your personal information is of utmost importance, which is why we've designed our privacy practices to comply with the Australian Privacy Act and the Australian Privacy Principles (APPs).</p>
            </div>

            <div class="section">
                <h3>Information We Collect</h3>
                <p>DeepFlow collects the following types of information:</p>
                <ul>
                    <li><strong>Account Information:</strong> Username and securely hashed password</li>
                    <li><strong>Focus Session Data:</strong> Timer durations, start and end times</li>
                    <li><strong>Energy Levels:</strong> Self-reported energy ratings before and after focus sessions</li>
                    <li><strong>Flow Shelf Items:</strong> Task notes and ideas you add during focus sessions</li>
                </ul>
                <p class="emphasize">We do NOT collect your real name, email address, location data, or any other identifying information beyond your chosen username.</p>
            </div>

            <div class="section">
                <h3>How We Use Your Information</h3>
                <p>The information we collect is used solely to:</p>
                <ul>
                    <li>Provide and improve the DeepFlow application functionality</li>
                    <li>Analyze patterns in your focus sessions and energy levels to help you identify optimal working times</li>
                    <li>Maintain the security of your account</li>
                </ul>
                <p>Your data is only processed for these explicit purposes and is not shared with third parties or used for marketing purposes.</p>
            </div>

            <div class="section">
                <h3>Data Security</h3>
                <p>We implement appropriate security measures to protect your data, including:</p>
                <ul>
                    <li>Password hashing using industry-standard techniques</li>
                    <li>Secure authentication and session management</li>
                    <li>Regular security reviews of our codebase</li>
                    <li>Data access controls that ensure you only have access to your own information</li>
                </ul>
            </div>

            <div class="section">
                <h3>Data Breach Notification</h3>
                <p>In accordance with the Notifiable Data Breaches (NDB) scheme under the Privacy Act, we will:</p>
                <ul>
                    <li>Notify you promptly if a data breach occurs that is likely to result in serious harm</li>
                    <li>Provide details about what information was affected</li>
                    <li>Advise you on steps to take to protect yourself from potential harm</li>
                    <li>Report eligible breaches to the Office of the Australian Information Commissioner (OAIC)</li>
                </ul>
            </div>

            <div class="section">
                <h3>Accessibility Commitment</h3>
                <p>DeepFlow is designed with neurodivergent users in mind. We are committed to providing an accessible experience for all users, in alignment with the Disability Discrimination Act 1992 and <a href="{{ url_for('privacy_user') }}">Privacy Policy</a>.</p>
                <p>Our accessibility features include:</p>
                <ul>
                    <li>OpenDyslexic font support for improved readability</li>
                    <li>High contrast mode for visual accessibility</li>
                    <li>Focus-friendly interface designed for ADHD users</li>
                    <li>Non-disruptive notifications and controls</li>
                </ul>
            </div>

            <div class="section">
                <h3>Changes to This Policy</h3>
                <p>We may update this privacy policy from time to time to reflect changes in our practices or for other operational, legal, or regulatory reasons. We will notify you of any material changes through the application.</p>
            </div>

            <div class="section">
                <h3>Contact Us</h3>
                <p>If you have any questions or concerns about this privacy policy or our data practices, please contact us at privacy@deepflow.example.com.</p>
            </div>
            
            <div class="footer">
                <p>Last Updated: {{ last_updated }}</p>
            </div>
        </div>
        
        <!-- Data Management Tab -->
        <div id="data-tab" class="tab-content">
            <h2>Data Management</h2>
            
            <div class="section">
                <h3>Your Data Rights</h3>
                <p>Under the Australian Privacy Act and the Australian Privacy Principles, you have the right to:</p>
                <ul>
                    <li><strong>Access:</strong> View all data we hold about you</li>
                    <li><strong>Export:</strong> Download your data in a portable format</li>
                    <li><strong>Delete:</strong> Delete your account and all associated data</li>
                    <li><strong>Correct:</strong> Update any inaccurate information in your account</li>
                </ul>
            </div>
            
            <div class="section">
                <h3>Export Your Data</h3>
                <p>Download a copy of all your data in JSON format.</p>
                <a href="{{ url_for('export_user_data') }}" class="btn-submit" style="display: inline-block; text-decoration: none; margin-top: 10px;">
                    <i class="fas fa-file-export"></i> Export All My Data
                </a>
            </div>
            
            <div class="section">
                <h3>Delete Your Account</h3>
                <p class="emphasize">Warning: This action is permanent and cannot be undone. All your data will be permanently deleted.</p>
                <a href="{{ url_for('delete_account') }}" class="btn-submit" style="background-color: #dc3545; display: inline-block; text-decoration: none; margin-top: 10px;">
                    <i class="fas fa-user-times"></i> Delete My Account
                </a>
            </div>
        </div>

        <a href="{{ url_for('dashboard') }}" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <script>
        function changeFont(fontType) {
            const bodyElement = document.getElementById('body-element');
            if (fontType === 'dyslexic') {
                bodyElement.classList.add('dyslexic-font');
            } else {
                bodyElement.classList.remove('dyslexic-font');
            }
            // Save preference to localStorage
            localStorage.setItem('deepflow_font_preference', fontType);
        }

        function updateCountrySelection(countryCode) {
            const stateProvinceGroup = document.getElementById('state-province-group');
            const stateProvinceSelect = document.getElementById('state_province');
            const timezoneInfo = document.getElementById('timezone-info');
            
            // Define states/provinces for countries with multiple timezones
            const stateProvinceData = {
                'US': {
                    'CA': 'California',
                    'NY': 'New York',
                    'TX': 'Texas',
                    'FL': 'Florida',
                    'IL': 'Illinois',
                    'WA': 'Washington',
                    'CO': 'Colorado',
                    'AZ': 'Arizona',
                    'HI': 'Hawaii',
                    'AK': 'Alaska'
                },
                'CA': {
                    'ON': 'Ontario',
                    'QC': 'Quebec',
                    'BC': 'British Columbia',
                    'AB': 'Alberta',
                    'SK': 'Saskatchewan',
                    'MB': 'Manitoba',
                    'NB': 'New Brunswick',
                    'NS': 'Nova Scotia',
                    'PE': 'Prince Edward Island',
                    'NL': 'Newfoundland and Labrador'
                },
                'AU': {
                    'NSW': 'New South Wales',
                    'VIC': 'Victoria',
                    'QLD': 'Queensland',
                    'WA': 'Western Australia',
                    'SA': 'South Australia',
                    'TAS': 'Tasmania',
                    'NT': 'Northern Territory',
                    'ACT': 'Australian Capital Territory'
                },
                'UK': {
                    'England': 'England',
                    'Scotland': 'Scotland',
                    'Wales': 'Wales',
                    'Northern Ireland': 'Northern Ireland'
                },
                'BR': {
                    'SP': 'SÃ£o Paulo',
                    'RJ': 'Rio de Janeiro',
                    'AC': 'Acre',
                    'AM': 'Amazonas'
                }
            };
            
            if (stateProvinceData[countryCode]) {
                // Show state/province selection
                stateProvinceGroup.style.display = 'block';
                
                // Clear existing options
                stateProvinceSelect.innerHTML = '<option value="">Select...</option>';
                
                // Add state/province options
                for (const [code, name] of Object.entries(stateProvinceData[countryCode])) {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    if (code === '{{ current_state }}') {
                        option.selected = true;
                    }
                    stateProvinceSelect.appendChild(option);
                }
                
                timezoneInfo.textContent = 'Select your state/province for precise timezone';
            } else {
                // Hide state/province selection for countries with single timezone
                stateProvinceGroup.style.display = 'none';
                stateProvinceSelect.value = '';
            }
        }

        function updateCountryPreference(countryCode) {
            // This function is kept for backward compatibility
            // but now we use the form submission instead of AJAX
            console.log('Country preference will be updated on form submission');
        }

        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Deactivate all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Activate the selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Find and activate the tab button
            const tabMap = {
                'account': 0,
                'preferences': 1,
                'privacy': 2,
                'data': 3
            };
            const tabIndex = tabMap[tabName] || 0;
            tabs[tabIndex].classList.add('active');
        }

        // Load saved preferences on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedFont = localStorage.getItem('deepflow_font_preference');
            if (savedFont) {
                document.getElementById('font-select').value = savedFont;
                changeFont(savedFont);
            }
            
            // Initialize state/province dropdown based on current country
            const currentCountry = '{{ current_country }}';
            if (currentCountry) {
                updateCountrySelection(currentCountry);
            }
        });
    </script>
</body>
</html>
