<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - DeepFlow</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }
        .back-button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        h1 {
            margin-top: 0;
        }
        h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
            color: #2c3e50;
        }
        .section {
            margin-bottom: 30px;
        }
        .emphasize {
            background-color: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #6c757d;
            font-size: 0.9em;
        }
        /* Enhanced accessibility controls */
        .accessibility-controls {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .font-selector {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .font-selector:hover {
            box-shadow: 0 0 8px rgba(0,123,255,0.5);
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        @font-face {
            font-family: 'OpenDyslexic';
            src: url('{{ url_for("static", filename="fonts/OpenDyslexic-Regular.otf") }}') format('opentype');
        }
        
        /* New styles for settings forms */
        .settings-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn-submit {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-submit:hover {
            background-color: #0056b3;
        }
        .flash-message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .flash-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom-color: #fff;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Advanced Features Styles */
        .advanced-features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.1);
        }
        .feature-toggle {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .feature-toggle input[type="checkbox"] {
            margin-top: 4px;
            transform: scale(1.2);
            accent-color: #007bff;
        }
        .toggle-label {
            display: flex;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            flex: 1;
        }
        .feature-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        .feature-description {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .feature-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 5px 5px 0;
        }
        .feature-info p {
            margin: 0;
            color: #1565c0;
        }
        
        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 12px 24px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background-color: #28a745;
            border-left: 4px solid #1e7e34;
        }

        .toast.info {
            background-color: #17a2b8;
            border-left: 4px solid #117a8b;
        }

        .toast.warning {
            background-color: #ffc107;
            color: #212529;
            border-left: 4px solid #d39e00;
        }

        .toast.error {
            background-color: #dc3545;
            border-left: 4px solid #bd2130;
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast-message {
            flex-grow: 1;
            font-weight: 500;
        }

        /* Feature status indicators */
        .feature-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .feature-status.enabled {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feature-status.disabled {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feature-toggle label {
            position: relative;
        }

        /* Improved checkbox styling */
        .feature-toggle input[type="checkbox"] {
            appearance: none;
            width: 50px;
            height: 26px;
            background-color: #ccc;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }

        .feature-toggle input[type="checkbox"]:checked {
            background-color: #007bff;
        }

        .feature-toggle input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .feature-toggle input[type="checkbox"]:checked::before {
            transform: translateX(24px);
        }
    </style>
</head>
<body id="body-element">
    <div class="header">
        <h1>DeepFlow Settings</h1>
        <p>Manage your account and preferences</p>
    </div>
    <div class="container">
        <div class="accessibility-controls">
            <h3 style="width: 100%; margin-top: 0; margin-bottom: 10px; color: #2c3e50;"><i class="fas fa-universal-access"></i> Accessibility Options</h3>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Settings Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('account')">Account Settings</div>
            <div class="tab" onclick="switchTab('preferences')">Preferences</div>
            <div class="tab" onclick="switchTab('privacy')">Privacy Policy</div>
            <div class="tab" onclick="switchTab('data')">Data Management</div>
        </div>
        
        <!-- Account Settings Tab -->
        <div id="account-tab" class="tab-content active">
            <h2>Account Settings</h2>
            
            <div class="section">
                <h3>Update Username</h3>
                <form action="{{ url_for('settings') }}" method="post" class="settings-form">
                    <input type="hidden" name="action" value="update_username">
                    <div class="form-group">
                        <label for="new_username">New Username:</label>
                        <input type="text" id="new_username" name="new_username" required>
                    </div>
                    <div class="form-group">
                        <label for="username_current_password">Current Password (to verify):</label>
                        <input type="password" id="username_current_password" name="current_password" required>
                    </div>
                    <button type="submit" class="btn-submit">Update Username</button>
                </form>
            </div>
            
            <div class="section">
                <h3>Change Password</h3>
                <form action="{{ url_for('settings') }}" method="post" class="settings-form">
                    <input type="hidden" name="action" value="update_password">
                    <div class="form-group">
                        <label for="password_current_password">Current Password:</label>
                        <input type="password" id="password_current_password" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label for="new_password">New Password:</label>
                        <input type="password" id="new_password" name="new_password" required>
                        <small>Must be at least 10 characters with uppercase, number, and symbol</small>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Confirm New Password:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn-submit">Change Password</button>
                </form>
            </div>
        </div>
        
        <!-- Preferences Tab -->
        <div id="preferences-tab" class="tab-content">
            <h2>Preferences</h2>
            
            <div class="section">
                <h3>Regional Settings</h3>
                <form method="post" style="max-width: 400px;">
                    <input type="hidden" name="action" value="update_country">
                    <div class="form-group">
                        <label for="country">Country/Region:</label>
                        <select id="country" name="country" required onchange="updateCountrySelection(this.value)">
                            <option value="US" {% if current_country == 'US' %}selected{% endif %}>🇺🇸 United States</option>
                            <option value="UK" {% if current_country == 'UK' %}selected{% endif %}>🇬🇧 United Kingdom</option>
                            <option value="AU" {% if current_country == 'AU' %}selected{% endif %}>🇦🇺 Australia</option>
                            <option value="CA" {% if current_country == 'CA' %}selected{% endif %}>🇨🇦 Canada</option>
                            <option value="DE" {% if current_country == 'DE' %}selected{% endif %}>🇩🇪 Germany</option>
                            <option value="FR" {% if current_country == 'FR' %}selected{% endif %}>🇫🇷 France</option>
                            <option value="ES" {% if current_country == 'ES' %}selected{% endif %}>🇪🇸 Spain</option>
                            <option value="IT" {% if current_country == 'IT' %}selected{% endif %}>🇮🇹 Italy</option>
                            <option value="JP" {% if current_country == 'JP' %}selected{% endif %}>🇯🇵 Japan</option>
                            <option value="CN" {% if current_country == 'CN' %}selected{% endif %}>🇨🇳 China</option>
                            <option value="IN" {% if current_country == 'IN' %}selected{% endif %}>🇮🇳 India</option>
                            <option value="BR" {% if current_country == 'BR' %}selected{% endif %}>🇧🇷 Brazil</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="state-province-group" style="display: none;">
                        <label for="state_province">State/Province/Region:</label>
                        <select id="state_province" name="state_province">
                            <option value="">Select...</option>
                        </select>
                        <small id="timezone-info" class="text-muted"></small>
                    </div>
                    
                    <small class="text-muted">This affects date/time formats and timezone display in graphs and reports.</small>
                    <br><br>
                    <button type="submit" class="btn-submit">Update Location</button>
                </form>
            </div>

            <div class="section">
                <h3>DeepFlow Advanced Features</h3>
                <p>Configure which advanced features are enabled during your focus sessions:</p>
                
                <div class="advanced-features-grid">
                    <div class="feature-card">
                        <div class="feature-toggle">
                            <input type="checkbox" id="enable-start-checkin" onchange="toggleStartCheckinFeature(this.checked)" checked>
                            <label for="enable-start-checkin" class="toggle-label">
                                <span class="feature-title">
                                    Start-Session Energy Check-In
                                    <span id="start-checkin-status" class="feature-status enabled">ENABLED</span>
                                </span>
                                <span class="feature-description">Get prompted to log your energy level before starting a focus session</span>
                            </label>
                        </div>
                    </div>

                    <div class="feature-card">
                        <div class="feature-toggle">
                            <input type="checkbox" id="enable-mid-checkin" onchange="toggleMidCheckinFeature(this.checked)" checked>
                            <label for="enable-mid-checkin" class="toggle-label">
                                <span class="feature-title">
                                    Mid-Session Energy Check-In
                                    <span id="mid-checkin-status" class="feature-status enabled">ENABLED</span>
                                </span>
                                <span class="feature-description">Optional prompts at the halfway point of long sessions to track your energy levels</span>
                            </label>
                        </div>
                    </div>

                    <div class="feature-card">
                        <div class="feature-toggle">
                            <input type="checkbox" id="enable-end-checkin" onchange="toggleEndCheckinFeature(this.checked)" checked>
                            <label for="enable-end-checkin" class="toggle-label">
                                <span class="feature-title">
                                    End-Session Energy Check-In
                                    <span id="end-checkin-status" class="feature-status enabled">ENABLED</span>
                                </span>
                                <span class="feature-description">Get prompted to log your energy level after completing a focus session</span>
                            </label>
                        </div>
                    </div>

                    <div class="feature-card">
                        <div class="feature-toggle">
                            <input type="checkbox" id="enable-energy-log" onchange="toggleEnergyLogFeature(this.checked)" checked>
                            <label for="enable-energy-log" class="toggle-label">
                                <span class="feature-title">
                                    Energy Level Tracking
                                    <span id="energy-log-status" class="feature-status enabled">ENABLED</span>
                                </span>
                                <span class="feature-description">Track and analyze your energy patterns before, during, and after sessions</span>
                            </label>
                        </div>
                    </div>

                    <div class="feature-card">
                        <div class="feature-toggle">
                            <input type="checkbox" id="enable-sound" onchange="toggleSoundFeature(this.checked)">
                            <label for="enable-sound" class="toggle-label">
                                <span class="feature-title">
                                    Background Soundscapes
                                    <span id="sound-status" class="feature-status disabled">DISABLED</span>
                                </span>
                                <span class="feature-description">Play ambient sounds during focus sessions to maintain concentration</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="feature-info">
                    <p><strong>Note:</strong> These settings are saved automatically and will apply to all your future timer sessions. You can change them at any time.</p>
                </div>
            </div>
        </div>
        
        <!-- Privacy Policy Tab -->
        <div id="privacy-tab" class="tab-content">
            <h2>Privacy Policy</h2>
            
            <div class="section">
                <h3>Introduction</h3>
                <p>Welcome to DeepFlow's Privacy Policy. This policy describes how we collect, use, and protect your personal information as you use our application designed to support neurodivergent users, especially those with ADHD, in managing focus sessions and tracking energy levels.</p>
                <p>We understand that your privacy and the security of your personal information is of utmost importance, which is why we've designed our privacy practices to comply with the Australian Privacy Act and the Australian Privacy Principles (APPs).</p>
            </div>

            <div class="section">
                <h3>Information We Collect</h3>
                <p>DeepFlow collects the following types of information:</p>
                <ul>
                    <li><strong>Account Information:</strong> Username and securely hashed password</li>
                    <li><strong>Focus Session Data:</strong> Timer durations, start and end times</li>
                    <li><strong>Energy Levels:</strong> Self-reported energy ratings before and after focus sessions</li>
                    <li><strong>Flow Shelf Items:</strong> Task notes and ideas you add during focus sessions</li>
                </ul>
                <p class="emphasize">We do NOT collect your real name, email address, location data, or any other identifying information beyond your chosen username.</p>
            </div>

            <div class="section">
                <h3>How We Use Your Information</h3>
                <p>The information we collect is used solely to:</p>
                <ul>
                    <li>Provide and improve the DeepFlow application functionality</li>
                    <li>Analyze patterns in your focus sessions and energy levels to help you identify optimal working times</li>
                    <li>Maintain the security of your account</li>
                </ul>
                <p>Your data is only processed for these explicit purposes and is not shared with third parties or used for marketing purposes.</p>
            </div>

            <div class="section">
                <h3>Data Security</h3>
                <p>We implement appropriate security measures to protect your data, including:</p>
                <ul>
                    <li>Password hashing using industry-standard techniques</li>
                    <li>Secure authentication and session management</li>
                    <li>Regular security reviews of our codebase</li>
                    <li>Data access controls that ensure you only have access to your own information</li>
                </ul>
            </div>

            <div class="section">
                <h3>Data Breach Notification</h3>
                <p>In accordance with the Notifiable Data Breaches (NDB) scheme under the Privacy Act, we will:</p>
                <ul>
                    <li>Notify you promptly if a data breach occurs that is likely to result in serious harm</li>
                    <li>Provide details about what information was affected</li>
                    <li>Advise you on steps to take to protect yourself from potential harm</li>
                    <li>Report eligible breaches to the Office of the Australian Information Commissioner (OAIC)</li>
                </ul>
            </div>

            <div class="section">
                <h3>Accessibility Commitment</h3>
                <p>DeepFlow is designed with neurodivergent users in mind. We are committed to providing an accessible experience for all users, in alignment with the Disability Discrimination Act 1992 and <a href="{{ url_for('privacy') }}">Privacy Policy</a>.</p>
                <p>Our accessibility features include:</p>
                <ul>
                    <li>OpenDyslexic font support for improved readability</li>
                    <li>High contrast mode for visual accessibility</li>
                    <li>Focus-friendly interface designed for ADHD users</li>
                    <li>Non-disruptive notifications and controls</li>
                </ul>
            </div>

            <div class="section">
                <h3>Changes to This Policy</h3>
                <p>We may update this privacy policy from time to time to reflect changes in our practices or for other operational, legal, or regulatory reasons. We will notify you of any material changes through the application.</p>
            </div>

            <div class="section">
                <h3>Contact Us</h3>
                <p>If you have any questions or concerns about this privacy policy or our data practices, please contact us at privacy@deepflow.example.com.</p>
            </div>
            
            <div class="footer">
                <p>Last Updated: {{ last_updated }}</p>
            </div>
        </div>
        
        <!-- Data Management Tab -->
        <div id="data-tab" class="tab-content">
            <h2>Data Management</h2>
            
            <div class="section">
                <h3>Your Data Rights</h3>
                <p>Under the Australian Privacy Act and the Australian Privacy Principles, you have the right to:</p>
                <ul>
                    <li><strong>Access:</strong> View all data we hold about you</li>
                    <li><strong>Export:</strong> Download your data in a portable format</li>
                    <li><strong>Delete:</strong> Delete your account and all associated data</li>
                    <li><strong>Correct:</strong> Update any inaccurate information in your account</li>
                </ul>
            </div>
            
            <div class="section">
                <h3>Export Your Data</h3>
                <p>Download a copy of all your data in JSON format.</p>
                <a href="{{ url_for('export_user_data') }}" class="btn-submit" style="display: inline-block; text-decoration: none; margin-top: 10px;">
                    <i class="fas fa-file-export"></i> Export All My Data
                </a>
            </div>
            
            <div class="section">
                <h3>Delete Your Account</h3>
                <p class="emphasize">Warning: This action is permanent and cannot be undone. All your data will be permanently deleted.</p>
                <a href="{{ url_for('delete_account') }}" class="btn-submit" style="background-color: #dc3545; display: inline-block; text-decoration: none; margin-top: 10px;">
                    <i class="fas fa-user-times"></i> Delete My Account
                </a>
            </div>
        </div>

        <a href="{{ url_for('dashboard') }}" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <script>
        function updateCountrySelection(countryCode) {
            const stateProvinceGroup = document.getElementById('state-province-group');
            const stateProvinceSelect = document.getElementById('state_province');
            const timezoneInfo = document.getElementById('timezone-info');
            
            // Define states/provinces for countries with multiple timezones
            const stateProvinceData = {
                'US': {
                    'CA': 'California',
                    'NY': 'New York',
                    'TX': 'Texas',
                    'FL': 'Florida',
                    'IL': 'Illinois',
                    'WA': 'Washington',
                    'CO': 'Colorado',
                    'AZ': 'Arizona',
                    'HI': 'Hawaii',
                    'AK': 'Alaska'
                },
                'CA': {
                    'ON': 'Ontario',
                    'QC': 'Quebec',
                    'BC': 'British Columbia',
                    'AB': 'Alberta',
                    'SK': 'Saskatchewan',
                    'MB': 'Manitoba',
                    'NB': 'New Brunswick',
                    'NS': 'Nova Scotia',
                    'PE': 'Prince Edward Island',
                    'NL': 'Newfoundland and Labrador'
                },
                'AU': {
                    'NSW': 'New South Wales',
                    'VIC': 'Victoria',
                    'QLD': 'Queensland',
                    'WA': 'Western Australia',
                    'SA': 'South Australia',
                    'TAS': 'Tasmania',
                    'NT': 'Northern Territory',
                    'ACT': 'Australian Capital Territory'
                },
                'UK': {
                    'England': 'England',
                    'Scotland': 'Scotland',
                    'Wales': 'Wales',
                    'Northern Ireland': 'Northern Ireland'
                },
                'BR': {
                    'SP': 'São Paulo',
                    'RJ': 'Rio de Janeiro',
                    'AC': 'Acre',
                    'AM': 'Amazonas'
                }
            };
            
            if (stateProvinceData[countryCode]) {
                // Show state/province selection
                stateProvinceGroup.style.display = 'block';
                
                // Clear existing options
                stateProvinceSelect.innerHTML = '<option value="">Select...</option>';
                
                // Add state/province options
                for (const [code, name] of Object.entries(stateProvinceData[countryCode])) {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    if (code === '{{ current_state }}') {
                        option.selected = true;
                    }
                    stateProvinceSelect.appendChild(option);
                }
                
                timezoneInfo.textContent = 'Select your state/province for precise timezone';
            } else {
                // Hide state/province selection for countries with single timezone
                stateProvinceGroup.style.display = 'none';
                stateProvinceSelect.value = '';
            }
        }

        function updateCountryPreference(countryCode) {
            // This function is kept for backward compatibility
            // but now we use the form submission instead of AJAX
            console.log('Country preference will be updated on form submission');
        }

        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Deactivate all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Activate the selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Find and activate the tab button
            const tabMap = {
                'account': 0,
                'preferences': 1,
                'privacy': 2,
                'data': 3
            };
            const tabIndex = tabMap[tabName] || 0;
            tabs[tabIndex].classList.add('active');
        }

        // Load saved preferences on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize state/province dropdown based on current country
            const currentCountry = '{{ current_country }}';
            if (currentCountry) {
                updateCountrySelection(currentCountry);
            }
            
            // Load saved advanced features settings
            loadAdvancedFeaturesSettings();
        });

        // Advanced Settings Toggle Functions
        function toggleStartCheckinFeature(enabled) {
            console.log('Start-Session Energy Check-In:', enabled ? 'Enabled' : 'Disabled');
            
            // Check if energy logging is enabled when trying to enable check-in
            if (enabled) {
                const energyLogCheckbox = document.getElementById('enable-energy-log');
                if (energyLogCheckbox && !energyLogCheckbox.checked) {
                    // Revert the checkbox and show warning
                    const startCheckinCheckbox = document.getElementById('enable-start-checkin');
                    if (startCheckinCheckbox) {
                        startCheckinCheckbox.checked = false;
                    }
                    showToast('Please enable Energy Level Tracking first before enabling individual check-ins.', 'warning');
                    return;
                }
            }
            
            // Update status indicator immediately for responsive feel
            updateFeatureStatus('start-checkin-status', enabled);
            
            // Show confirmation toast
            showToast(
                enabled ? 'Start-Session Energy Check-In enabled! You\'ll be prompted to log your energy before starting sessions.' 
                       : 'Start-Session Energy Check-In disabled. Timers will start immediately without energy prompts.',
                enabled ? 'success' : 'info'
            );
            
            // Update backend preferences
            updatePreferenceBackend('enable_start_checkin', enabled);
            
            if (enabled) {
                enableStartCheckin();
            } else {
                disableStartCheckin();
            }
        }

        function toggleMidCheckinFeature(enabled) {
            console.log('Mid-Session Energy Check-In:', enabled ? 'Enabled' : 'Disabled');
            
            // Check if energy logging is enabled when trying to enable check-in
            if (enabled) {
                const energyLogCheckbox = document.getElementById('enable-energy-log');
                if (energyLogCheckbox && !energyLogCheckbox.checked) {
                    // Revert the checkbox and show warning
                    const midCheckinCheckbox = document.getElementById('enable-mid-checkin');
                    if (midCheckinCheckbox) {
                        midCheckinCheckbox.checked = false;
                    }
                    showToast('Please enable Energy Level Tracking first before enabling individual check-ins.', 'warning');
                    return;
                }
            }
            
            // Update status indicator immediately for responsive feel
            updateFeatureStatus('mid-checkin-status', enabled);
            
            // Show confirmation toast
            showToast(
                enabled ? 'Mid-Session Energy Check-In enabled! You\'ll receive optional energy check prompts during long sessions.' 
                       : 'Mid-Session Energy Check-In disabled. No mid-session prompts will appear during timers.',
                enabled ? 'success' : 'info'
            );
            
            // Update backend preferences
            updatePreferenceBackend('enable_mid_checkin', enabled);
            
            if (enabled) {
                enableMidSessionCheckin();
            } else {
                disableMidSessionCheckin();
            }
        }

        function toggleEndCheckinFeature(enabled) {
            console.log('End-Session Energy Check-In:', enabled ? 'Enabled' : 'Disabled');
            
            // Check if energy logging is enabled when trying to enable check-in
            if (enabled) {
                const energyLogCheckbox = document.getElementById('enable-energy-log');
                if (energyLogCheckbox && !energyLogCheckbox.checked) {
                    // Revert the checkbox and show warning
                    const endCheckinCheckbox = document.getElementById('enable-end-checkin');
                    if (endCheckinCheckbox) {
                        endCheckinCheckbox.checked = false;
                    }
                    showToast('Please enable Energy Level Tracking first before enabling individual check-ins.', 'warning');
                    return;
                }
            }
            
            // Update status indicator immediately for responsive feel
            updateFeatureStatus('end-checkin-status', enabled);
            
            // Show confirmation toast
            showToast(
                enabled ? 'End-Session Energy Check-In enabled! You\'ll be prompted to log your energy after completing sessions.' 
                       : 'End-Session Energy Check-In disabled. Timers will stop immediately without energy prompts.',
                enabled ? 'success' : 'info'
            );
            
            // Update backend preferences
            updatePreferenceBackend('enable_end_checkin', enabled);
            
            if (enabled) {
                enableEndCheckin();
            } else {
                disableEndCheckin();
            }
        }

        function toggleEnergyLogFeature(enabled) {
            console.log('Energy Level Tracking:', enabled ? 'Enabled' : 'Disabled');
            
            // Update status indicator immediately for responsive feel
            updateFeatureStatus('energy-log-status', enabled);
            
            // If energy logging is being disabled, automatically disable all check-ins
            if (!enabled) {
                // Disable all check-in features
                const startCheckinCheckbox = document.getElementById('enable-start-checkin');
                const midCheckinCheckbox = document.getElementById('enable-mid-checkin');
                const endCheckinCheckbox = document.getElementById('enable-end-checkin');
                
                if (startCheckinCheckbox) {
                    startCheckinCheckbox.checked = false;
                    updateFeatureStatus('start-checkin-status', false);
                    disableStartCheckin();
                }
                if (midCheckinCheckbox) {
                    midCheckinCheckbox.checked = false;
                    updateFeatureStatus('mid-checkin-status', false);
                    disableMidSessionCheckin();
                }
                if (endCheckinCheckbox) {
                    endCheckinCheckbox.checked = false;
                    updateFeatureStatus('end-checkin-status', false);
                    disableEndCheckin();
                }
                
                // Show comprehensive toast message
                showToast(
                    'Energy Level Tracking disabled. All energy check-ins (start, mid, and end session) have been automatically disabled.',
                    'info'
                );
                
                // Update all preferences in backend at once
                updateMultiplePreferencesBackend({
                    'enable_energy_log': false,
                    'enable_start_checkin': false,
                    'enable_mid_checkin': false,
                    'enable_end_checkin': false
                });
            } else {
                // Show simple toast for enabling
                showToast(
                    'Energy Level Tracking enabled! You can now configure individual check-in settings.',
                    'success'
                );
                
                // Update just energy log preference
                updatePreferenceBackend('enable_energy_log', enabled);
            }
            
            if (enabled) {
                enableEnergyTracking();
            } else {
                disableEnergyTracking();
            }
        }

        function toggleSoundFeature(enabled) {
            console.log('Background Soundscapes:', enabled ? 'Enabled' : 'Disabled');
            
            // Update status indicator immediately for responsive feel
            updateFeatureStatus('sound-status', enabled);
            
            // Show confirmation toast
            showToast(
                enabled ? 'Background Soundscapes enabled! Ambient sounds will be available during your focus sessions.' 
                       : 'Background Soundscapes disabled. No ambient sounds will play during sessions.',
                enabled ? 'success' : 'info'
            );
            
            // Update backend preferences
            updatePreferenceBackend('enable_sound', enabled);
            
            if (enabled) {
                enableBackgroundSounds();
            } else {
                disableBackgroundSounds();
            }
        }

        // Helper function to update feature status indicators
        function updateFeatureStatus(statusId, enabled) {
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                statusElement.textContent = enabled ? 'ENABLED' : 'DISABLED';
                statusElement.className = enabled ? 'feature-status enabled' : 'feature-status disabled';
            }
        }

        // Toast notification functions
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Choose appropriate icon based on type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'info':
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
            }

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Function to update preference in backend
        function updatePreferenceBackend(preferenceKey, enabled) {
            const preferences = {};
            preferences[preferenceKey] = enabled;
            
            fetch('/update_user_preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(preferences)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success confirmation
                    showToast('Settings saved successfully!', 'success', 2000);
                } else {
                    console.error('Failed to update preference:', data.error);
                    showToast('Failed to save settings. Please try again.', 'error');
                    
                    // Revert toggle and status if backend update failed
                    revertFeatureToggle(preferenceKey, !enabled);
                }
            })
            .catch(error => {
                console.error('Error updating preference:', error);
                showToast('Connection error. Settings may not be saved.', 'error');
                
                // Revert toggle and status if request failed
                revertFeatureToggle(preferenceKey, !enabled);
            });
        }

        // Function to update multiple preferences in backend at once
        function updateMultiplePreferencesBackend(preferences) {
            fetch('/update_user_preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(preferences)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success confirmation
                    showToast('Settings saved successfully!', 'success', 2000);
                    
                    // If backend returned updated preferences, sync UI
                    if (data.updated_preferences) {
                        console.log('Backend returned updated preferences:', data.updated_preferences);
                        // Update UI to match backend state in case any preferences were overridden
                        const backendPrefs = data.updated_preferences;
                        Object.keys(backendPrefs).forEach(key => {
                            const value = backendPrefs[key];
                            const featureMap = {
                                'enable_start_checkin': { toggleId: 'enable-start-checkin', statusId: 'start-checkin-status' },
                                'enable_mid_checkin': { toggleId: 'enable-mid-checkin', statusId: 'mid-checkin-status' },
                                'enable_end_checkin': { toggleId: 'enable-end-checkin', statusId: 'end-checkin-status' },
                                'enable_energy_log': { toggleId: 'enable-energy-log', statusId: 'energy-log-status' },
                                'enable_sound': { toggleId: 'enable-sound', statusId: 'sound-status' }
                            };
                            
                            const feature = featureMap[key];
                            if (feature) {
                                const toggle = document.getElementById(feature.toggleId);
                                if (toggle && toggle.checked !== value) {
                                    toggle.checked = value;
                                    updateFeatureStatus(feature.statusId, value);
                                }
                            }
                        });
                    }
                } else {
                    console.error('Failed to update preferences:', data.error);
                    showToast('Failed to save settings. Please try again.', 'error');
                    
                    // Revert all changed preferences
                    Object.keys(preferences).forEach(key => {
                        revertFeatureToggle(key, !preferences[key]);
                    });
                }
            })
            .catch(error => {
                console.error('Error updating preferences:', error);
                showToast('Connection error. Settings may not be saved.', 'error');
                
                // Revert all changed preferences
                Object.keys(preferences).forEach(key => {
                    revertFeatureToggle(key, !preferences[key]);
                });
            });
        }

        // Helper function to revert feature toggle and status
        function revertFeatureToggle(preferenceKey, originalState) {
            // Find the correct toggle element
            const featureMap = {
                'enable_start_checkin': { toggleId: 'enable-start-checkin', statusId: 'start-checkin-status' },
                'enable_mid_checkin': { toggleId: 'enable-mid-checkin', statusId: 'mid-checkin-status' },
                'enable_end_checkin': { toggleId: 'enable-end-checkin', statusId: 'end-checkin-status' },
                'enable_energy_log': { toggleId: 'enable-energy-log', statusId: 'energy-log-status' },
                'enable_sound': { toggleId: 'enable-sound', statusId: 'sound-status' }
            };

            const feature = featureMap[preferenceKey];
            if (feature) {
                const toggle = document.getElementById(feature.toggleId);
                if (toggle) {
                    toggle.checked = originalState;
                }
                
                // Update status indicator
                updateFeatureStatus(feature.statusId, originalState);
            }
        }

        // Feature control functions
        function enableStartCheckin() {
            window.startCheckinEnabled = true;
        }

        function disableStartCheckin() {
            window.startCheckinEnabled = false;
        }

        function enableMidSessionCheckin() {
            window.midSessionCheckinEnabled = true;
        }

        function disableMidSessionCheckin() {
            window.midSessionCheckinEnabled = false;
        }

        function enableEndCheckin() {
            window.endCheckinEnabled = true;
        }

        function disableEndCheckin() {
            window.endCheckinEnabled = false;
        }

        function enableEnergyTracking() {
            window.energyTrackingEnabled = true;
            // Show energy-related UI elements on dashboard
            const energyElements = document.querySelectorAll('.energy-tracking');
            energyElements.forEach(el => el.style.display = 'block');
        }

        function disableEnergyTracking() {
            window.energyTrackingEnabled = false;
            // Hide energy-related UI elements on dashboard
            const energyElements = document.querySelectorAll('.energy-tracking');
            energyElements.forEach(el => el.style.display = 'none');
        }

        function enableBackgroundSounds() {
            window.backgroundSoundsEnabled = true;
            if (window.soundManager) {
                window.soundManager.enable();
            }
        }

        function disableBackgroundSounds() {
            window.backgroundSoundsEnabled = false;
            if (window.soundManager) {
                window.soundManager.disable();
            }
        }

        // Load advanced features settings from backend
        function loadAdvancedFeaturesSettings() {
            fetch('/get_user_preferences')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.preferences) {
                        const prefs = data.preferences;
                        
                        // Set checkbox states based on backend preferences
                        const startCheckinCheckbox = document.getElementById('enable-start-checkin');
                        const midCheckinCheckbox = document.getElementById('enable-mid-checkin');
                        const endCheckinCheckbox = document.getElementById('enable-end-checkin');
                        const energyLogCheckbox = document.getElementById('enable-energy-log');
                        const soundCheckbox = document.getElementById('enable-sound');

                        if (startCheckinCheckbox) {
                            startCheckinCheckbox.checked = prefs.enable_start_checkin;
                            updateFeatureStatus('start-checkin-status', prefs.enable_start_checkin);
                            // Set the feature state without showing toast
                            if (prefs.enable_start_checkin) {
                                enableStartCheckin();
                            } else {
                                disableStartCheckin();
                            }
                        }
                        if (midCheckinCheckbox) {
                            midCheckinCheckbox.checked = prefs.enable_mid_checkin;
                            updateFeatureStatus('mid-checkin-status', prefs.enable_mid_checkin);
                            // Set the feature state without showing toast
                            if (prefs.enable_mid_checkin) {
                                enableMidSessionCheckin();
                            } else {
                                disableMidSessionCheckin();
                            }
                        }
                        if (endCheckinCheckbox) {
                            endCheckinCheckbox.checked = prefs.enable_end_checkin;
                            updateFeatureStatus('end-checkin-status', prefs.enable_end_checkin);
                            // Set the feature state without showing toast
                            if (prefs.enable_end_checkin) {
                                enableEndCheckin();
                            } else {
                                disableEndCheckin();
                            }
                        }
                        if (energyLogCheckbox) {
                            energyLogCheckbox.checked = prefs.enable_energy_log;
                            updateFeatureStatus('energy-log-status', prefs.enable_energy_log);
                            // Set the feature state without showing toast
                            if (prefs.enable_energy_log) {
                                enableEnergyTracking();
                            } else {
                                disableEnergyTracking();
                            }
                        }
                        if (soundCheckbox) {
                            soundCheckbox.checked = prefs.enable_sound;
                            updateFeatureStatus('sound-status', prefs.enable_sound);
                            // Set the feature state without showing toast
                            if (prefs.enable_sound) {
                                enableBackgroundSounds();
                            } else {
                                disableBackgroundSounds();
                            }
                        }

                        console.log('Advanced features settings loaded from backend:', prefs);
                    } else {
                        console.error('Failed to load preferences from backend:', data.error);
                        // Fallback to localStorage if backend fails
                        loadSettingsFromLocalStorage();
                    }
                })
                .catch(error => {
                    console.error('Error fetching preferences from backend:', error);
                    // Fallback to localStorage if backend fails
                    loadSettingsFromLocalStorage();
                });
        }

        // Fallback function to load from localStorage
        function loadSettingsFromLocalStorage() {
            const startCheckinEnabled = localStorage.getItem('enableStartCheckin') !== 'false';
            const midCheckinEnabled = localStorage.getItem('enableMidCheckin') !== 'false';
            const endCheckinEnabled = localStorage.getItem('enableEndCheckin') !== 'false';
            const energyLogEnabled = localStorage.getItem('enableEnergyLog') !== 'false';
            const soundEnabled = localStorage.getItem('enableSound') === 'true';

            // Set checkbox states
            const startCheckinCheckbox = document.getElementById('enable-start-checkin');
            const midCheckinCheckbox = document.getElementById('enable-mid-checkin');
            const endCheckinCheckbox = document.getElementById('enable-end-checkin');
            const energyLogCheckbox = document.getElementById('enable-energy-log');
            const soundCheckbox = document.getElementById('enable-sound');

            if (startCheckinCheckbox) {
                startCheckinCheckbox.checked = startCheckinEnabled;
                updateFeatureStatus('start-checkin-status', startCheckinEnabled);
                // Set the feature state without showing toast
                if (startCheckinEnabled) {
                    enableStartCheckin();
                } else {
                    disableStartCheckin();
                }
            }
            if (midCheckinCheckbox) {
                midCheckinCheckbox.checked = midCheckinEnabled;
                updateFeatureStatus('mid-checkin-status', midCheckinEnabled);
                // Set the feature state without showing toast
                if (midCheckinEnabled) {
                    enableMidSessionCheckin();
                } else {
                    disableMidSessionCheckin();
                }
            }
            if (endCheckinCheckbox) {
                endCheckinCheckbox.checked = endCheckinEnabled;
                updateFeatureStatus('end-checkin-status', endCheckinEnabled);
                // Set the feature state without showing toast
                if (endCheckinEnabled) {
                    enableEndCheckin();
                } else {
                    disableEndCheckin();
                }
            }
            if (energyLogCheckbox) {
                energyLogCheckbox.checked = energyLogEnabled;
                updateFeatureStatus('energy-log-status', energyLogEnabled);
                // Set the feature state without showing toast
                if (energyLogEnabled) {
                    enableEnergyTracking();
                } else {
                    disableEnergyTracking();
                }
            }
            if (soundCheckbox) {
                soundCheckbox.checked = soundEnabled;
                updateFeatureStatus('sound-status', soundEnabled);
                // Set the feature state without showing toast
                if (soundEnabled) {
                    enableBackgroundSounds();
                } else {
                    disableBackgroundSounds();
                }
            }
        }
    </script>

    <!-- Toast notification container -->
    <div id="toast-container" class="toast-container"></div>
</body>
</html>
